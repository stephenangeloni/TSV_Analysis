<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced TSV File Analyzer</title>
    <style>
        :root {
            --ubs-red: #EC0016;
            --ubs-dark-gray: #2C2C2C;
            --ubs-light-gray: #F5F5F5;
            --ubs-white: #FFFFFF;
            --background-color: var(--ubs-white);
            --text-color: var(--ubs-dark-gray);
            --header-background: var(--ubs-white);
            --content-background: var(--ubs-light-gray);
            --table-even-row: var(--ubs-light-gray);
            --modal-background: rgba(0, 0, 0, 0.7);
            --code-background: #f4f4f4;
            --code-text: #333;
            --toggle-background: #ccc;
            --toggle-button: #fff;
        }

        body.dark-mode {
            --background-color: #121212;
            --text-color: #E0E0E0;
            --header-background: #1E1E1E;
            --content-background: #2C2C2C;
            --table-even-row: #3A3A3A;
            --modal-background: rgba(255, 255, 255, 0.1);
            --code-background: #2d2d2d;
            --code-text: #e0e0e0;
            --toggle-background: #444444;
            --toggle-button: #fff;
        }

        body,
        html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Helvetica, Arial, sans-serif;
            line-height: 1.4;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh; // Set height to 100% of the viewport height
        }

        .header {
            background-color: var(--header-background);
            color: var(--text-color);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--ubs-red);
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
        }

        .content {
            flex: 1; // Allow content to grow and fill available space
            padding: 20px;
            background-color: var(--content-background);
            width: calc(100% - 40px);
            box-sizing: border-box;
            margin: 0 auto;
        }

        #fileInput {
            display: none;
        }

        .file-input-label {
            background-color: var(--header-background);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            border: 1px solid var(--text-color);
        }

        .file-input-label:hover {
            background-color: var(--content-background);
        }

        #filteredRowsCount {
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 18px;
        }

        .filter-container {
            margin-bottom: 20px;
        }

        #sqlQuery {
            width: 100%;
            height: 60px;
            margin-bottom: 10px;
            border: 1px solid var(--text-color);
            padding: 10px;
            font-family: monospace;
            box-sizing: border-box;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        #runQuery {
            background-color: var(--ubs-red);
            color: var(--ubs-white);
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        #runQuery:hover {
            background-color: #D10014;
        }

        #filteredResultsArea {
            background-color: var(--background-color);
            border: 1px solid var(--text-color);
            padding: 20px;
            overflow-x: auto;
            flex: 1; // Allow filtered results area to grow and fill available space
        }

        .table-container {
            overflow-x: auto;
            flex: 1; // Allow the table container to grow and fill available space
        }

        table {
            width: 100%;
            font-size: 14px;
            line-height: 1.2;
            border-spacing: 0;
            border-collapse: separate;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--text-color);
        }

        th {
            background-color: var(--ubs-red);
            color: var(--ubs-white);
            position: sticky;
            top: 0;
            font-size: 15px;
            z-index: 10;
        }

        tr:nth-child(even) {
            background-color: var(--table-even-row);
        }

        tr {
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000; // Increased z-index to ensure modal is above other elements
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-background);
        }

        .modal-content {
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            border: 1px solid var(--text-color);
            width: 85%;
            height: 85%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .close {
            color: var(--text-color);
            align-self: flex-end;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: var(--ubs-red);
            text-decoration: none;
        }

        #modalHeader {
            margin-bottom: 10px;
            font-weight: bold;
        }

        #modalContent {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--code-background);
            color: var(--code-text);
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .clicked-row {
            font-weight: bold;
            font-style: italic;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-background);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--toggle-button);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--toggle-background);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <label for="fileInput" class="file-input-label">Choose File</label>
            <input type="file" id="fileInput" accept=".tsv,.txt">
            <div class="logo">Analyzer</div>
            <label class="switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="content">
            <div id="filteredRowsCount"></div>
            <div class="filter-container">
                <textarea id="sqlQuery"
                    placeholder="Enter your SQL query here...">SELECT * FROM data LIMIT 1000</textarea>
                <button id="runQuery">Run Query</button>
            </div>
            <div id="filteredResultsArea"></div>
        </div>
    </div>
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalHeader"></div>
            <div id="modalContent"></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        // Global variables
        let db;
        let headers = [];
        let sanitizedHeaders = [];

        // Check if logging is enabled
        const isLoggingEnabled = new URLSearchParams(window.location.search).get('log') === '1';

        // Logging function
        function log(...args) {
            if (isLoggingEnabled) {
                console.log(`${getTimestamp()} -`, ...args);
            }
        }

        // Error logging function
        function logError(...args) {
            if (isLoggingEnabled) {
                console.error(`${getTimestamp()} -`, ...args);
            }
        }

        // Timestamp function for logging
        function getTimestamp() {
            return new Date().toISOString();
        }

        // Performance measurement
        const perfMeasure = (name, fn) => {
            const start = performance.now();
            fn();
            const end = performance.now();
            log(`${name} took ${end - start} milliseconds.`);
        };

        // Initialize SQL.js
        initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` }).then(SQL => {
            db = new SQL.Database();
            log('SQL.js initialized');
        });

        // Sanitize header for SQLite column name
        function sanitizeHeader(header) {
            return header.trim().replace(/[^a-zA-Z0-9_]/g, '_');
        }

        // Check if a row is valid (all columns except the last one are not empty)
        function isValidRow(row) {
            for (let i = 0; i < row.length - 1; i++) {
                if (row[i].trim() === '') {
                    return false;
                }
            }
            return true;
        }

        // File parsing
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                perfMeasure('File Parsing and DB Creation', () => {
                    log('Starting file parsing');
                    const content = e.target.result;
                    const lines = content.split('\n');
                    log(`Total lines in file: ${lines.length}`);

                    headers = lines[0].split('\t').map(h => h.trim());
                    sanitizedHeaders = headers.map(sanitizeHeader);
                    log(`Original Headers: ${headers.join(', ')}`);
                    log(`Sanitized Headers: ${sanitizedHeaders.join(', ')}`);

                    // Create table
                    const createTableSQL = `CREATE TABLE data (${sanitizedHeaders.map(h => `"${h}" TEXT`).join(', ')})`;
                    log(`Creating table with SQL: ${createTableSQL}`);
                    db.run(createTableSQL);

                    // Log database structure if logging is enabled
                    if (isLoggingEnabled) {
                        log('Database structure:', db.exec("SELECT sql FROM sqlite_master WHERE type='table'").map(row => row.values[0]).join('\n'));
                    }

                    // Insert data
                    const stmt = db.prepare(`INSERT INTO data VALUES (${sanitizedHeaders.map(() => '?').join(', ')})`);
                    log('Prepared statement for data insertion');
                    db.run('BEGIN TRANSACTION');
                    let validRowCount = 0;
                    let invalidRowCount = 0;
                    lines.slice(1).forEach((line, index) => {
                        if (line.trim() !== '') {
                            const row = line.split('\t');
                            log(`Processing row ${index + 1}: ${row.join(' | ')}`);
                            if (isValidRow(row)) {
                                stmt.run(row);
                                validRowCount++;
                                log(`Row ${index + 1} is valid and inserted`);
                            } else {
                                invalidRowCount++;
                                log(`Row ${index + 1} is invalid and skipped`);
                            }
                        } else {
                            log(`Empty line at row ${index + 1}, skipped`);
                        }
                    });
                    db.run('COMMIT');
                    stmt.free();
                    log(`Inserted ${validRowCount} valid rows into the database.`);
                    log(`Skipped ${invalidRowCount} invalid rows.`);
                });

                // Display initial results
                runQuery();
            };

            reader.readAsText(file);
        });

        // Run SQL query
        function runQuery() {
            const query = document.getElementById('sqlQuery').value;
            perfMeasure('Run Query', () => {
                try {
                    log(`Executing query: ${query}`);
                    const stmt = db.prepare(query);
                    log(`Statement prepared: ${stmt}`); // Log the statement object
                    
                    // Get column names immediately after preparing the statement
                    const columnNames = stmt.getColumnNames();
                    log(`Column Names: ${columnNames.join(', ')}`); // Log column names

                    const results = [];
                    while (stmt.step()) {
                        results.push(stmt.get());
                    }
                    stmt.free();
                    log(`Query executed successfully. Result count: ${results.length}`);

                    // Check if column names are empty
                    if (columnNames.length === 0) {
                        log('No column names returned. Check the table structure.');
                        const schema = db.exec("SELECT sql FROM sqlite_master WHERE type='table'").map(row => row.values[0]).join('\n');
                        log(`Table Schema: ${schema}`);
                    }

                    displayResults([{ columns: columnNames, values: results }]);
                } catch (error) {
                    logError('SQL Error:', error);
                    document.getElementById('filteredResultsArea').innerHTML = `<p>Error: ${error.message}</p>`;
                    log('Error details:', error);
                    if (error.stack) {
                        log('Error stack:', error.stack);
                    }
                }
            });
        }

        // Display query results
        function displayResults(results) {
            log('Displaying results');
            const filteredResultsArea = document.getElementById('filteredResultsArea');

            if (results.length === 0 || results[0].values.length === 0) {
                filteredResultsArea.innerHTML = '<p>No results found.</p>';
                log('No results to display');
                return;
            }

            let tableHTML = '<div class="table-container"><table>';

            // Create header
            tableHTML += '<thead><tr>';
            results[0].columns.forEach(column => {
                const originalHeader = headers[sanitizedHeaders.indexOf(column)] || column;
                log(`Column: ${column}, Original Header: ${originalHeader}`); // Added logging
                tableHTML += `<th>${escapeHTML(originalHeader)}</th>`;
            });
            tableHTML += '</tr></thead>';

            // Create data rows (limit to 50,000 rows)
            tableHTML += '<tbody>';
            const rowsToDisplay = Math.min(results[0].values.length, 50000);
            for (let i = 0; i < rowsToDisplay; i++) {
                const row = results[0].values[i];
                tableHTML += '<tr>';
                row.forEach(cell => {
                    tableHTML += `<td>${escapeHTML(cell)}</td>`;
                });
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody>';

            tableHTML += '</table></div>';

            // Set the innerHTML once
            filteredResultsArea.innerHTML = tableHTML;

            // Update filtered rows count
            const totalRows = results[0].values.length;
            const displayedRows = rowsToDisplay;
            document.getElementById('filteredRowsCount').textContent =
                `Displaying ${displayedRows} of ${totalRows} filtered rows`;
            log(`Displayed ${displayedRows} of ${totalRows} filtered rows`);

            // Add click event listeners to table rows
            const table = filteredResultsArea.querySelector('table');
            table.addEventListener('click', handleRowClick);
        }

        // Handle row click
        function handleRowClick(event) {
            const row = event.target.closest('tr');
            if (!row) return;

            const cells = row.cells;
            if (cells.length < 3) return;

            const firstThreeColumns = Array.from(cells).slice(0, 3).map(cell => cell.textContent);
            const modalHeaderColumns = Array.from(cells).slice(0, 4).map(cell => cell.textContent);
            const lastColumn = sanitizedHeaders[sanitizedHeaders.length - 1];

            const query = `
                SELECT "${lastColumn}"
                FROM data
                WHERE "${sanitizedHeaders[0]}" = ? AND "${sanitizedHeaders[1]}" = ? AND "${sanitizedHeaders[2]}" = ?
            `;

            try {
                log('Executing row click query:', query);
                log('Parameters:', firstThreeColumns);
                const stmt = db.prepare(query);
                stmt.bind(firstThreeColumns);
                const results = [];
                while (stmt.step()) {
                    results.push(stmt.get());
                }
                stmt.free();
                log(`Row click query executed successfully. Result count: ${results.length}`);
                displayModal([{ values: results }], modalHeaderColumns, cells[cells.length - 1].textContent);
            } catch (error) {
                logError('SQL Error:', error);
                log('Error details:', error);
                if (error.stack) {
                    log('Error stack:', error.stack);
                }
            }
        }

        // Display modal with matching data
        function displayModal(results, modalHeaderColumns, clickedValue) {
            log('Displaying modal for:', modalHeaderColumns.join(' | '));
            const modalHeader = document.getElementById('modalHeader');
            const modalContent = document.getElementById('modalContent');
            const modal = document.getElementById('myModal');

            modalHeader.textContent = modalHeaderColumns.join(' | ');

            if (results.length === 0 || results[0].values.length === 0) {
                modalContent.textContent = 'No matching data found.';
                log('No matching data found for modal');
            } else {
                let contentText = '';
                results[0].values.forEach((row, index) => {
                    if (row[0] === clickedValue) {
                        contentText += `<span class="clicked-row">${escapeHTML(row[0])}</span>\n`;
                    } else {
                        contentText += `${escapeHTML(row[0])}\n`;
                    }
                });
                modalContent.innerHTML = contentText;
                log(`Modal content set with ${results[0].values.length} rows`);
            }

            modal.style.display = 'block';
        }

        // Helper function to escape HTML special characters
        function escapeHTML(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add event listener for the Run Query button
        document.getElementById('runQuery').addEventListener('click', runQuery);

        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        darkModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            log('Dark mode toggled');
        });

        // Modal close functionality
        const modal = document.getElementById('myModal');
        const span = document.getElementsByClassName('close')[0];

        span.onclick = function () {
            modal.style.display = 'none';
            log('Modal closed');
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
                log('Modal closed by clicking outside');
            }
        }
    </script>
</body>

</html>